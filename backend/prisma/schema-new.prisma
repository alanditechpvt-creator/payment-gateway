generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./prod.db"
}

// ==================== USER & AUTH ====================

model User {
  id                    String          @id @default(uuid())
  email                 String          @unique
  password              String
  role                  String          // ADMIN, WHITE_LABEL, MASTER_DISTRIBUTOR, DISTRIBUTOR, RETAILER
  status                String          @default("PENDING_ONBOARDING")
  
  // Profile Information
  firstName             String?
  lastName              String?
  phone                 String?
  businessName          String?
  profilePhoto          String?
  
  // Hierarchy
  parentId              String?
  parent                User?           @relation("UserHierarchy", fields: [parentId], references: [id])
  children              User[]          @relation("UserHierarchy")
  
  // KYC Information
  panNumber             String?
  panVerified           String          @default("PENDING")
  aadhaarNumber         String?
  aadhaarFront          String?
  aadhaarBack           String?
  aadhaarVerified       String          @default("PENDING")
  emailVerified         Boolean         @default(false)
  
  // Onboarding
  onboardingToken       String?         @unique
  onboardingTokenExpiry DateTime?
  
  // Email OTP
  emailOtp              String?
  emailOtpExpiry        DateTime?
  
  // Schema/Plan Assignment
  schemaId              String?
  schema                Schema?         @relation(fields: [schemaId], references: [id])
  
  // Security - Failed Login Tracking
  failedLoginAttempts   Int             @default(0)
  lastFailedLogin       DateTime?
  lockedUntil           DateTime?
  lockedReason          String?
  
  // Timestamps
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  lastLoginAt           DateTime?
  
  // Relations
  wallet                Wallet?
  permissions           UserPermission[]
  pgAssignments         UserPGAssignment[]
  
  // NEW: Payin rates (hierarchical)
  payinRates            UserPayinRate[]     @relation("UserPayinRates")
  assignedPayinRates    UserPayinRate[]     @relation("PayinRatesAssigned")
  
  // NEW: Payout rates (hierarchical)
  payoutRate            UserPayoutRate?     @relation("UserPayoutRate")
  assignedPayoutRates   UserPayoutRate[]    @relation("PayoutRatesAssigned")
  
  transactionsInitiated Transaction[]   @relation("TransactionInitiator")
  commissions           CommissionTransaction[]
  createdSchemas        Schema[]        @relation("SchemaCreator")
  refreshTokens         RefreshToken[]
  auditLogs             AuditLog[]
  notifications         Notification[]
  beneficiaries         Beneficiary[]
  announcements         Announcement[] @relation("AnnouncementCreator")
  
  @@index([role])
  @@index([status])
  @@index([parentId])
  @@index([schemaId])
  @@index([createdAt])
  @@index([role, status])
  @@index([parentId, role])
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
}

// ==================== PERMISSIONS ====================

model UserPermission {
  id                    String   @id @default(uuid())
  userId                String   @unique
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Permission Flags
  canCreateUsers        Boolean  @default(false)
  canManageWallet       Boolean  @default(false)
  canTransferWallet     Boolean  @default(false)
  canCreateSchema       Boolean  @default(false)
  canViewReports        Boolean  @default(true)
  canManagePG           Boolean  @default(false)
  canApproveUsers       Boolean  @default(false)
  canViewTransactions   Boolean  @default(true)
  canInitiatePayin      Boolean  @default(false)
  canInitiatePayout     Boolean  @default(false)
  canAssignRates        Boolean  @default(false)  // WL & MD can assign rates to downstream
  
  // Custom permissions JSON for extensibility
  customPermissions     String?
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

// ==================== WALLET ====================

model Wallet {
  id              String              @id @default(uuid())
  userId          String              @unique
  user            User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  balance         Float               @default(0)
  holdBalance     Float               @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  transactions    WalletTransaction[]
}

model WalletTransaction {
  id              String   @id @default(uuid())
  walletId        String
  wallet          Wallet   @relation(fields: [walletId], references: [id])
  type            String   // CREDIT, DEBIT, COMMISSION, TRANSFER_IN, TRANSFER_OUT, REFUND
  amount          Float
  balanceBefore   Float
  balanceAfter    Float
  description     String?
  referenceId     String?
  referenceType   String?
  createdAt       DateTime @default(now())
  
  @@index([walletId])
  @@index([type])
  @@index([createdAt])
  @@index([walletId, createdAt])
  @@index([walletId, type])
}

// ==================== PAYMENT GATEWAY ====================

model PaymentGateway {
  id              String              @id @default(uuid())
  name            String              @unique
  code            String              @unique
  description     String?
  
  // Configuration (encrypted in production)
  apiKey          String?
  apiSecret       String?
  merchantId      String?
  webhookSecret   String?
  configuration   String?
  
  // Status
  isActive        Boolean             @default(true)
  supportedTypes  String              @default("PAYIN,PAYOUT")
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  transactions    Transaction[]
  userAssignments UserPGAssignment[]
  transactionChannels TransactionChannel[]  // Available channels for this PG
  schemaPayinRates    SchemaPayinRate[]     // Payin rates per schema
  schemaPayoutConfigs SchemaPayoutConfig[]  // Payout config per schema
}

// ==================== TRANSACTION CHANNELS ====================
// Replaces CardType - Represents payment methods/channels
// Examples: UPI, Net Banking, Credit Card types, IMPS, etc.

model TransactionChannel {
  id              String    @id @default(uuid())
  pgId            String
  paymentGateway  PaymentGateway @relation(fields: [pgId], references: [id], onDelete: Cascade)
  
  // Channel identification
  code            String    // e.g., "upi", "netbanking", "credit_visa_normal", "imps"
  name            String    // e.g., "UPI", "Net Banking", "VISA Normal Card", "IMPS"
  category        String    // "UPI", "NETBANKING", "DEBITCARD", "CREDITCARD", "WALLET", "IMPS"
  
  // For card types - additional metadata
  cardNetwork     String?   // "VISA", "MASTER", "RUPAY", "AMEX", "DINERS"
  cardType        String?   // "NORMAL", "CORPORATE", "PREMIUM", "PLATINUM"
  
  // PG's cost for this channel (base rate for admin reference)
  baseCost        Float     @default(0.02)
  
  // Is this channel active
  isActive        Boolean   @default(true)
  
  // Is this admin-defined or system-defined
  isCustom        Boolean   @default(false)
  
  // Transaction type this channel is for
  transactionType String    @default("PAYIN") // "PAYIN" or "PAYOUT"
  
  // Mapping to PG response codes (JSON array)
  // Helps match PG API responses to our channels
  // e.g., ["visa", "VISA", "Visa Card", "credit_card_visa"]
  pgResponseCodes String?   // JSON array as string
  
  // Default rate for unknown channels (fallback)
  isDefault       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  schemaPayinRates SchemaPayinRate[]
  userPayinRates   UserPayinRate[]
  transactions     Transaction[]
  
  @@unique([pgId, code])
  @@index([pgId])
  @@index([category])
  @@index([cardNetwork])
  @@index([transactionType])
  @@index([isDefault])
}

// ==================== SCHEMA (MEMBERSHIP PLANS) ====================

model Schema {
  id              String          @id @default(uuid())
  name            String
  code            String          @unique
  description     String?
  
  // Who created this schema
  createdById     String
  createdBy       User            @relation("SchemaCreator", fields: [createdById], references: [id])
  
  // Applicable to which roles (comma separated)
  applicableRoles String          @default("RETAILER")
  
  isActive        Boolean         @default(true)
  isDefault       Boolean         @default(false)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  // Relations
  users           User[]
  payinRates      SchemaPayinRate[]     // Payin rates per channel
  payoutConfig    SchemaPayoutConfig?   // Payout slab configuration (one per schema)
}

// ==================== PAYIN RATE CONFIGURATION ====================
// Schema-level payin rates per transaction channel

model SchemaPayinRate {
  id                  String    @id @default(uuid())
  schemaId            String
  schema              Schema    @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  
  channelId           String
  transactionChannel  TransactionChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  pgId                String
  paymentGateway      PaymentGateway @relation(fields: [pgId], references: [id], onDelete: Cascade)
  
  // Rate for this schema + channel combination (percentage)
  // e.g., 0.02 = 2%
  payinRate           Float     @default(0.02)
  
  // Is this channel enabled for this schema
  isEnabled           Boolean   @default(true)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([schemaId, channelId])
  @@index([schemaId])
  @@index([channelId])
  @@index([pgId])
}

// User-level payin rate overrides (assigned by parent/MD)
model UserPayinRate {
  id                  String    @id @default(uuid())
  
  // User this rate applies to
  userId              String
  user                User      @relation("UserPayinRates", fields: [userId], references: [id], onDelete: Cascade)
  
  // Transaction channel this rate is for
  channelId           String
  transactionChannel  TransactionChannel @relation(fields: [channelId], references: [id], onDelete: Cascade)
  
  // Who assigned this rate (parent or admin)
  assignedById        String
  assignedBy          User      @relation("PayinRatesAssigned", fields: [assignedById], references: [id])
  
  // Custom rate for this user (must be >= schema rate + parent's markup)
  payinRate           Float
  
  isEnabled           Boolean   @default(true)
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  @@unique([userId, channelId])
  @@index([userId])
  @@index([channelId])
  @@index([assignedById])
}

// ==================== PAYOUT RATE CONFIGURATION ====================
// Schema-level payout configuration with slab-based pricing

model SchemaPayoutConfig {
  id              String    @id @default(uuid())
  schemaId        String    @unique
  schema          Schema    @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  
  // The designated payout PG for this schema
  pgId            String
  paymentGateway  PaymentGateway @relation(fields: [pgId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Slabs for this schema (flat charge based on amount)
  slabs           PayoutSlab[]
}

// Payout slabs - flat charge based on transaction amount range
model PayoutSlab {
  id                    String    @id @default(uuid())
  schemaPayoutConfigId  String
  config                SchemaPayoutConfig @relation(fields: [schemaPayoutConfigId], references: [id], onDelete: Cascade)
  
  minAmount             Float     // Minimum amount (inclusive)
  maxAmount             Float?    // Maximum amount (inclusive), null = unlimited
  flatCharge            Float     // Flat fee in rupees
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  
  @@index([schemaPayoutConfigId])
}

// User-level payout rate overrides (assigned by admin/parent)
model UserPayoutRate {
  id              String    @id @default(uuid())
  
  // User this rate applies to
  userId          String    @unique
  user            User      @relation("UserPayoutRate", fields: [userId], references: [id], onDelete: Cascade)
  
  // Who assigned this rate
  assignedById    String
  assignedBy      User      @relation("PayoutRatesAssigned", fields: [assignedById], references: [id])
  
  // User-specific payout slabs (overrides schema slabs)
  slabs           UserPayoutSlab[]
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// User-level payout slabs
model UserPayoutSlab {
  id                String    @id @default(uuid())
  userPayoutRateId  String
  userPayoutRate    UserPayoutRate @relation(fields: [userPayoutRateId], references: [id], onDelete: Cascade)
  
  minAmount         Float
  maxAmount         Float?
  flatCharge        Float
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  
  @@index([userPayoutRateId])
}

// ==================== USER PG ASSIGNMENT ====================
// Controls which PGs a user can access

model UserPGAssignment {
  id              String          @id @default(uuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  pgId            String
  paymentGateway  PaymentGateway  @relation(fields: [pgId], references: [id])
  
  isEnabled       Boolean         @default(true)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@unique([userId, pgId])
}

// ==================== TRANSACTIONS ====================

model Transaction {
  id                  String    @id @default(uuid())
  transactionId       String    @unique
  type                String    // PAYIN, PAYOUT
  status              String    @default("PENDING")
  
  // Amounts
  amount              Float
  pgCharges           Float     @default(0)
  platformCommission  Float     @default(0)
  netAmount           Float
  
  // User who initiated
  initiatorId         String
  initiator           User      @relation("TransactionInitiator", fields: [initiatorId], references: [id])
  
  // Payment Gateway
  pgId                String
  paymentGateway      PaymentGateway @relation(fields: [pgId], references: [id])
  pgTransactionId     String?
  pgResponse          String?
  
  // Transaction Channel (replaces cardType)
  channelId           String?
  transactionChannel  TransactionChannel? @relation(fields: [channelId], references: [id])
  
  // Raw payment method from PG response (for debugging & matching)
  rawPaymentMethod    String?
  
  // Customer Details
  customerName        String?
  customerEmail       String?
  customerPhone       String?
  
  // Beneficiary (for PAYOUT)
  beneficiaryId       String?
  beneficiary         Beneficiary? @relation("BeneficiaryTransactions", fields: [beneficiaryId], references: [id])
  beneficiaryName     String?
  beneficiaryAccount  String?
  beneficiaryIfsc     String?
  beneficiaryMode     String?   // IMPS, NEFT, RTGS
  
  // Timestamps
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  completedAt         DateTime?
  
  // Relations
  commissions         CommissionTransaction[]
  
  @@index([initiatorId])
  @@index([pgId])
  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([initiatorId, status])
  @@index([initiatorId, type])
  @@index([pgId, status])
  @@index([pgId, createdAt])
  @@index([channelId])
}

model CommissionTransaction {
  id              String        @id @default(uuid())
  transactionId   String
  transaction     Transaction   @relation(fields: [transactionId], references: [id])
  
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  level           Int
  rate            Float
  amount          Float
  
  creditedAt      DateTime?
  createdAt       DateTime      @default(now())
}

// ==================== BENEFICIARY ====================

model Beneficiary {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id])
  
  name            String
  accountNumber   String
  ifscCode        String
  bankName        String?
  accountType     String        @default("SAVINGS") // SAVINGS, CURRENT
  
  // Verification
  isVerified      Boolean       @default(false)
  verifiedAt      DateTime?
  
  // Status
  isActive        Boolean       @default(true)
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  transactions    Transaction[] @relation("BeneficiaryTransactions")
  
  @@index([userId])
}

// ==================== SYSTEM SETTINGS ====================

model SystemSettings {
  id                    String          @id @default(uuid())
  key                   String          @unique
  value                 String
  description           String?
  category              String          @default("GENERAL")
  dataType              String          @default("STRING")
  isEditable            Boolean         @default(true)
  
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
}

// ==================== AUDIT & NOTIFICATIONS ====================

model AuditLog {
  id          String   @id @default(uuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id])
  action      String
  entityType  String?
  entityId    String?
  metadata    String?
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  message     String
  type        String   @default("INFO")
  isRead      Boolean  @default(false)
  readAt      DateTime?
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([isRead])
}

model Announcement {
  id          String   @id @default(uuid())
  title       String
  content     String
  type        String   @default("INFO")
  targetRoles String?
  createdById String
  createdBy   User     @relation("AnnouncementCreator", fields: [createdById], references: [id])
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([isActive])
  @@index([createdAt])
}
